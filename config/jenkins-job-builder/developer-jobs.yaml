#########################################################################################
# Template for project Flow123d - DEVELOPER BUILDS
#########################################################################################


# defaults values
- defaults:
    name: flow123d-build
    node: "{platform}"
    workspace: "F123-{platform}-{build-type}"
    # properties:    
    #     - build-discarder:
    #         days-to-keep: 200
    #         num-to-keep: 200
    # wrappers:
    #   - build-name:
    #       name:  "${{PROPFILE,file=\"prop.file\",property=\"BUILD_NAME\"}}  #${{BUILD_NUMBER}}"

- project:
    name: "Multijob project debug"
    platform: linux
    build-type: debug
    unit-dir: 
      - $PLACEHOLDER_unit_list$
    test-dir:
      - $PLACEHOLDER_test_list$
    jobs:
      - "Flow123d-{platform}-debug-configure"
    #   - "Flow123d-{platform}-{build-type}-build-libs"
    #   - "Flow123d-{platform}-{build-type}-unit-test-{unit-dir}"
    #   - "Flow123d-{platform}-{build-type}-build"
    #   - "Flow123d-{platform}-{build-type}-test-{test-dir}"
      - "Flow123d-{platform}-debug-multijob"

- job-template:
    name: "Flow123d-{platform}-debug-configure"
    display-name: "{platform} debug / Flow123d configure"
    defaults: flow123d-build
    builders:
      - shell: |
          ls -la
          pwd
          whoami

- job-template:
    name: "Flow123d-{platform}-debug-multijob"
    display-name: "{platform} debug / Flow123d multijob"
    project-type: multijob
    defaults: flow123d-build

    block-downstream: yes
    scm:
      - git:
          url: https://github.com/flow123d/flow123d.git
          basedir: flow123d     # workspace/flow123d
          browser: githubweb
          browser-url: https://github.com/flow123d/flow123d/
          skip-tag: true

    triggers: 
      - github
      
    wrappers:
      # injection doesn't work under cygwin; see other solution for release multijob
      - inject:
          script-content: 
            "echo \"BUILD_NAME=${{GIT_BRANCH#origin/}}@${{GIT_COMMIT:0:6}}\" >prop.file"

      # set build name different way to have it even at start of the job
      - build-name:
          name:  "${{GIT_BRANCH}}@${{GIT_REVISION, length=6}} #${{BUILD_NUMBER}}"
    builders:
      - shell: |
          docker ps             
      - multijob:
          name: "Configure Phase"
          condition: SUCCESSFUL
          projects:  
            - name: "Flow123d-{platform}-debug-configure"
#       - multijob:
#           name: "Build Flow123d libraries"
#           condition: COMPLETED
#           projects:
#             - name: "Flow123d-{platform}-debug-build-libs"
#       - multijob:
#           name: "Unit tests"
#           condition: COMPLETED
#           projects:     #*UNIT-JOBS
#             - name: "Flow123d-{platform}-debug-unit-test-$PLACEHOLDER_unit_list$"
#       - multijob:
#           name: "Build Flow123d"
#           condition: SUCCESSFUL
#           projects:
#             - name: "Flow123d-{platform}-debug-build"
#       - multijob:
#           name: "Integration tests"
#           condition: COMPLETED
#           projects:
# # $PLACEHOLDER_test_list$
#             - name: "Flow123d-{platform}-debug-test-$PLACEHOLDER_test_list$"
#               kill-phase-on: NEVER
# # $PLACEHOLDER_test_list$